language: go

go:
  - "1.10.x"

sudo: false

services:
  - docker

before_install:
  - docker-compose up -d
  - |
    jq --version
    ctr=0
    max_retries=30
    while [ $(curl -I -u "root:123qwe123" localhost:10080/users/sign_in | head -1 | grep 200 | wc -l | tr -d ' ') -ne 1 ]; do
      ctr=`expr $ctr + 1`
      echo waiting for gitlab to come up
      sleep 10
      if [ $ctr == $max_retries ]; then
        echo "max retries (${max_retries}) reached"
        exit 1
      fi
    done
    echo "============   installing jq     =============="
    # mv ./testdata/jq-linux64 /usr/local/bin/jq 
    # export PATH=$PATH:/usr/local/bin
    # jq --version
    echo "============ setting up test data ============="
    ./testdata/get_token.sh # creates the token.txt
    ./testdata/seeder.sh # reads the token.txt
    echo "============ test data completed  ============="

script:
  - |
    cat token.txt
    export GITLAB_PRIVATE_TOKEN=$(cat token.txt)
    make coverage

after_success:
  - bash <(curl -s https://codecov.io/bash) # Set CODECOV_TOKEN in your environment variables.


