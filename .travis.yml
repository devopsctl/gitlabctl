language: go

branches:
  only:
  - master
  - stable

go:
  - "1.10.x"

sudo: false

services:
  - docker

before_install:
  - docker-compose up -d
  - |
    jq --version

    source testdata/credentials.sh

    ctr=0
    max_retries=30
    while [ $(curl -I -u "${GITLAB_USERNAME}:${GITLAB_PASSWORD}" ${GITLAB_HTTP_URL}/users/sign_in | head -1 | grep 200 | wc -l | tr -d ' ') -ne 1 ]; do
      ctr=`expr $ctr + 1`
      echo waiting for gitlab to come up
      sleep 10
      if [ $ctr == $max_retries ]; then
        echo "max retries (${max_retries}) reached"
        exit 1
      fi
    done
    echo "============ setting up test data ============="
    ./testdata/seeder.sh 
    echo "============ test data completed  ============="

script:
  - |
    source testdata/credentials.sh
    make coverage

after_success:
  - bash <(curl -s https://codecov.io/bash) # Set CODECOV_TOKEN in your environment variables.


